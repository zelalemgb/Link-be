-- Laboratory test master dataset curated from open references:
-- 1) University of Iowa Pathology Handbook (https://www.healthcare.uiowa.edu/path_handbook/handbook/testlist.html)
-- 2) WHO. Basic Laboratory Tests for Clinical Practice, 3rd ed. (https://iris.who.int/bitstream/handle/10665/44168/9789241547260_eng.pdf)
-- The ranges/panic values below are representative adult values published in those open references.

DELETE FROM public.lab_test_master;

WITH master_data AS (
  SELECT *
  FROM (VALUES
    -- Hematology / CBC
    ('HGB','Hemoglobin','Hematology','Complete Blood Count','13.8-17.2','12.1-15.1',NULL,'g/dL','Whole Blood (EDTA)','7.0','20.0','Cyanmethemoglobin spectrophotometry',4,
     'Quantifies oxygen-carrying capacity of blood to detect anemia/polycythemia',15,24,'Flag if change >2 g/dL (~15%) within 24h','University of Iowa Pathology Handbook'),
    ('HCT','Hematocrit','Hematology','Complete Blood Count','41-50','36-44',NULL,'%', 'Whole Blood (EDTA)','20','60','Impedance/optical cell counting',4,
     'Packed cell volume as percentage of blood; screens anemia or dehydration',15,24,'Flag if swing >7 percentage points within 24h','University of Iowa Pathology Handbook'),
    ('WBC','White Blood Cell Count','Hematology','Complete Blood Count','', '', '4.0-11.0','x10^3/µL','Whole Blood (EDTA)','2.0','30.0','Impedance/optical flow cytometry',4,
     'Total leukocyte count used to identify infection, inflammation, or marrow failure',50,24,'Delta if >50% change relative to previous day','University of Iowa Pathology Handbook'),
    ('RBC','Red Blood Cell Count','Hematology','Complete Blood Count','4.5-5.9','4.1-5.1',NULL,'x10^6/µL','Whole Blood (EDTA)',NULL,NULL,'Impedance/optical cell counting',4,
     'Absolute erythrocyte count supporting anemia workups',12,24,'Flag if >12% change within 24h','University of Iowa Pathology Handbook'),
    ('PLT','Platelet Count','Hematology','Complete Blood Count','150-450','150-450',NULL,'x10^3/µL','Whole Blood (EDTA)','20','1000','Impedance/optical cell counting',4,
     'Assesses thrombocytopenia/thrombocytosis risk for bleeding or thrombosis',30,12,'Delta if platelets drop >30% within 12h','University of Iowa Pathology Handbook'),
    ('MCV','Mean Corpuscular Volume','Hematology','Complete Blood Count','80-100','80-100',NULL,'fL','Whole Blood (EDTA)',NULL,NULL,'Calculated (HCT/RBC)',4,
     'Average size of circulating RBCs helps classify anemia',NULL,NULL,NULL,'University of Iowa Pathology Handbook'),
    ('MCH','Mean Corpuscular Hemoglobin','Hematology','Complete Blood Count','27-33','27-33',NULL,'pg','Whole Blood (EDTA)',NULL,NULL,'Calculated (HGB/RBC)',4,
     'Average hemoglobin mass per RBC assists in anemia phenotyping',NULL,NULL,NULL,'University of Iowa Pathology Handbook'),
    ('MCHC','Mean Corpuscular Hemoglobin Concentration','Hematology','Complete Blood Count','32-36','32-36',NULL,'g/dL','Whole Blood (EDTA)',NULL,NULL,'Calculated (HGB/HCT)',4,
     'Defines hemoglobin concentration per RBC volume to detect spherocytosis or hypochromia',NULL,NULL,NULL,'University of Iowa Pathology Handbook'),
    ('RDW','Red Cell Distribution Width','Hematology','Complete Blood Count','11.5-14.5','11.5-14.5',NULL,'%', 'Whole Blood (EDTA)',NULL,NULL,'Coefficient of variation of RBC size',4,
     'Anisocytosis metric helpful in differentiating iron deficiency vs. thalassemia',NULL,NULL,NULL,'University of Iowa Pathology Handbook'),
    ('NEUT%','Neutrophils %','Hematology','Complete Blood Count','40-70','40-70',NULL,'%', 'Whole Blood (EDTA)','<10%','>90%','Flow cytometry differential',4,
     'Relative neutrophil distribution useful in infection or marrow suppression',50,24,'Delta if proportion shifts >50% vs prior day','University of Iowa Pathology Handbook'),
    ('LYMPH%','Lymphocytes %','Hematology','Complete Blood Count','20-40','20-40',NULL,'%', 'Whole Blood (EDTA)',NULL,NULL,'Flow cytometry differential',4,
     'Relative lymphocyte count supports viral vs bacterial infection assessment',40,24,'Delta if >40% change vs prior day','University of Iowa Pathology Handbook'),
    ('MONO%','Monocytes %','Hematology','Complete Blood Count','2-8','2-8',NULL,'%', 'Whole Blood (EDTA)',NULL,NULL,'Flow cytometry differential',4,
     'Monocyte proportion indicates chronic inflammation or marrow recovery',100,48,'Flag doubling within 48h suggesting monocytosis','University of Iowa Pathology Handbook'),
    ('EOS%','Eosinophils %','Hematology','Complete Blood Count','1-4','1-4',NULL,'%', 'Whole Blood (EDTA)',NULL,NULL,'Flow cytometry differential',4,
     'Monitors allergic disease and parasitic infection burden',100,48,'Flag doubling within 48h','University of Iowa Pathology Handbook'),
    ('BASO%','Basophils %','Hematology','Complete Blood Count','0-1','0-1',NULL,'%', 'Whole Blood (EDTA)',NULL,NULL,'Flow cytometry differential',4,
     'Basophil increase can indicate myeloproliferative disorders',NULL,NULL,NULL,'University of Iowa Pathology Handbook'),
    ('RETIC','Reticulocyte Count','Hematology',NULL,'0.5-1.5','0.5-1.5',NULL,'%', 'Whole Blood (EDTA)',NULL,NULL,'New methylene blue manual count',24,
     'Estimates marrow response to anemia/hemolysis',50,48,'Delta if >50% swing within 48h','WHO Basic Laboratory Tests'),

    -- Coagulation
    ('PT','Prothrombin Time','Coagulation','Coagulation Panel',NULL,NULL,'11-13.5','seconds','Platelet-poor Citrated Plasma','>30','--','Thromboplastin-based clot detection',2,
     'Extrinsic coagulation pathway screen; monitors warfarin',20,24,'Delta alert if PT increases >20% vs previous day','University of Iowa Pathology Handbook'),
    ('INR','International Normalized Ratio','Coagulation','Coagulation Panel',NULL,NULL,'0.8-1.2','Ratio','Platelet-poor Citrated Plasma','<0.8','>5.0','Derived from PT',2,
     'Standardized warfarin monitoring metric',25,24,'Delta alert if INR change >0.5 within 24h','University of Iowa Pathology Handbook'),
    ('APTT','Activated Partial Thromboplastin Time','Coagulation','Coagulation Panel',NULL,NULL,'25-35','seconds','Platelet-poor Citrated Plasma','<20','>90','Kaolin/cephalin clot detection',2,
     'Intrinsic pathway assessment, heparin monitoring',25,24,'Delta alert if >25% change vs prior result','University of Iowa Pathology Handbook'),
    ('FIB','Fibrinogen','Coagulation',NULL,NULL,NULL,'200-400','mg/dL','Platelet-poor Citrated Plasma','<100','>600','Clauss clot-rate',8,
     'Acute phase reactant, low levels indicate consumption coagulopathy',30,24,'Delta alert if drop >30% within 24h','University of Iowa Pathology Handbook'),
    ('DDIM','D-Dimer','Coagulation',NULL,NULL,NULL,'<0.5','µg/mL FEU','Platelet-poor Citrated Plasma',NULL,NULL,'Latex immunoassay',8,
     'Detects fibrin degradation seen in VTE/DIC',50,48,'Delta if >50% increase while anticoagulated','University of Iowa Pathology Handbook'),

    -- Basic Metabolic Panel
    ('NA','Sodium','Chemistry','Basic Metabolic Panel',NULL,NULL,'136-145','mmol/L','Serum or Plasma','120','160','Ion-selective electrode',2,
     'Major extracellular cation controlling osmolality',3,24,'Flag if >3% change (≈4 mmol/L) within 24h','University of Iowa Pathology Handbook'),
    ('K','Potassium','Chemistry','Basic Metabolic Panel',NULL,NULL,'3.5-5.1','mmol/L','Serum or Plasma','2.5','6.5','Ion-selective electrode',2,
     'Essential for cardiac conduction and neuromuscular function',10,6,'Delta alert if >10% shift within 6h (e.g., >0.5 mmol/L)','University of Iowa Pathology Handbook'),
    ('CL','Chloride','Chemistry','Basic Metabolic Panel',NULL,NULL,'98-106','mmol/L','Serum or Plasma','80','115','Ion-selective electrode',2,
     'Principal extracellular anion balancing cations',5,24,'Delta if >5% change vs prior day','University of Iowa Pathology Handbook'),
    ('CO2','Carbon Dioxide (Bicarbonate)','Chemistry','Basic Metabolic Panel',NULL,NULL,'22-29','mmol/L','Serum or Plasma','12','40','Enzymatic/ISE',2,
     'Reflects metabolic acid-base status',20,12,'Delta alert if >20% swing within 12h','University of Iowa Pathology Handbook'),
    ('BUN','Blood Urea Nitrogen','Chemistry','Basic Metabolic Panel',NULL,NULL,'7-20','mg/dL','Serum or Plasma',NULL,'100','Urease UV rate',4,
     'Renal function marker from protein metabolism',30,72,'Delta if >30% rise within 72h','WHO Basic Laboratory Tests'),
    ('CREAT','Creatinine','Chemistry','Basic Metabolic Panel',NULL,NULL,'0.7-1.3','mg/dL','Serum or Plasma',NULL,'10.0','Enzymatic creatinase',4,
     'Estimates GFR and renal clearance',25,48,'Delta if >25% rise within 48h (possible AKI)','WHO Basic Laboratory Tests'),
    ('GLU','Glucose (Fasting)','Chemistry','Basic Metabolic Panel',NULL,NULL,'70-99','mg/dL','Serum or Plasma','<40','>450','Hexokinase',2,
     'Primary energy substrate; monitors dysglycemia',25,6,'Delta if >25% shift within 6h','WHO Basic Laboratory Tests'),
    ('CA','Calcium','Chemistry','Comprehensive Metabolic Panel',NULL,NULL,'8.6-10.2','mg/dL','Serum', '6.5','13.0','Arsenazo dye',4,
     'Evaluates parathyroid, bone, and renal status',15,24,'Delta if >15% change in 24h','University of Iowa Pathology Handbook'),
    ('MG','Magnesium','Chemistry',NULL,NULL,NULL,'1.7-2.3','mg/dL','Serum', '1.0','4.5','Xylidyl blue photometry',8,
     'Cation for neuromuscular stability and cofactor activity',20,24,'Delta if >20% change vs prior day','WHO Basic Laboratory Tests'),
    ('PHOS','Phosphorus','Chemistry',NULL,NULL,NULL,'2.5-4.5','mg/dL','Serum','1.0','7.0','Molybdate UV',8,
     'Reflects renal excretion, bone turnover, and acid-base disorders',25,24,'Delta if >25% swing vs prior day','WHO Basic Laboratory Tests'),

    -- Liver Function
    ('ALT','Alanine Aminotransferase','Chemistry','Hepatic Panel','0-55','0-55',NULL,'U/L','Serum',NULL,NULL,'Enzymatic rate assay',6,
     'Hepatocellular injury marker',20,48,'Delta if >20% rise within 48h for hospitalized pts','University of Iowa Pathology Handbook'),
    ('AST','Aspartate Aminotransferase','Chemistry','Hepatic Panel','0-40','0-40',NULL,'U/L','Serum',NULL,NULL,'Enzymatic rate assay',6,
     'Cytosolic/mitochondrial enzyme elevated in liver/cardiac muscle injury',20,48,'Delta alert if >20% change','University of Iowa Pathology Handbook'),
    ('ALP','Alkaline Phosphatase','Chemistry','Hepatic Panel','40-130','40-130',NULL,'U/L','Serum',NULL,NULL,'PNPP colorimetric',12,
     'Cholestatic pattern indicator and bone turnover marker',25,72,'Delta if >25% change in 72h','University of Iowa Pathology Handbook'),
    ('GGT','Gamma-Glutamyl Transferase','Chemistry','Hepatic Panel','0-65','0-45',NULL,'U/L','Serum',NULL,NULL,'L-γ-glutamyl-3-carboxy-4-nitroanilide',12,
     'Sensitive marker of biliary obstruction or alcohol use',30,72,'Delta if >30% change vs prior week','University of Iowa Pathology Handbook'),
    ('TBILI','Total Bilirubin','Chemistry','Hepatic Panel',NULL,NULL,'0.2-1.2','mg/dL','Serum','<0.1','>20','Diazo colorimetric',4,
     'Measures conjugated/unconjugated bilirubin for liver function',25,24,'Delta if >25% rise day-to-day','University of Iowa Pathology Handbook'),
    ('DBILI','Direct Bilirubin','Chemistry','Hepatic Panel',NULL,NULL,'0.0-0.3','mg/dL','Serum',NULL,NULL,'Diazo',4,
     'Conjugated fraction; elevates with cholestasis',30,24,'Delta if >30% change vs prior day','University of Iowa Pathology Handbook'),
    ('ALB','Albumin','Chemistry','Hepatic Panel','3.5-5.0','3.5-5.0',NULL,'g/dL','Serum','2.0','6.0','BCG dye-binding',24,
     'Major plasma protein reflecting hepatic synthesis and nutrition',15,168,'Delta if >15% change within a week','WHO Basic Laboratory Tests'),
    ('TP','Total Protein','Chemistry','Hepatic Panel','6.0-8.3','6.0-8.3',NULL,'g/dL','Serum',NULL,NULL,'Biuret colorimetric',24,
     'Sum of albumin and globulins; screens nutritional/immunologic status',15,168,'Delta if >15% change within a week','WHO Basic Laboratory Tests'),

    -- Lipids & Cardiovascular
    ('CHOL','Total Cholesterol','Chemistry','Lipid Panel',NULL,NULL,'<200','mg/dL','Serum',NULL,NULL,'Enzymatic cholesterol oxidase',24,
     'Atherosclerotic risk screening',20,168,'Delta if >20% change vs prior week','WHO Basic Laboratory Tests'),
    ('HDL','HDL Cholesterol','Chemistry','Lipid Panel',NULL,NULL,'>40','mg/dL','Serum',NULL,NULL,'Direct enzymatic',24,
     'Protective lipoprotein fraction',20,168,'Delta if >20% change vs prior week','WHO Basic Laboratory Tests'),
    ('LDL','Calculated LDL','Chemistry','Lipid Panel',NULL,NULL,'<130','mg/dL','Serum',NULL,NULL,'Friedewald calculation',24,
     'Primary therapeutic lipid target',20,168,'Delta if >20% change vs prior week','WHO Basic Laboratory Tests'),
    ('TRIG','Triglycerides','Chemistry','Lipid Panel',NULL,NULL,'<150','mg/dL','Serum',NULL,NULL,'Glycerol phosphate oxidase',24,
     'Energy storage lipids; hypertriglyceridemia risk for pancreatitis',30,48,'Delta if >30% rise within 48h inpatient','WHO Basic Laboratory Tests'),
    ('TROP','High Sensitivity Troponin I','Cardiac',NULL,NULL,NULL,'<18','ng/L','Plasma (Heparin)','--','>100','Immunoassay',2,
     'Detects myocardial injury with rapid turnaround',20,3,'Delta algorithm: >20% change within 3h indicates acute injury','University of Iowa Pathology Handbook'),
    ('CKMB','CK-MB Mass','Cardiac',NULL,NULL,NULL,'<5.0','ng/mL','Serum',NULL,NULL,'Immunoassay',6,
     'Cardiac isoenzyme for MI trending (legacy test)',25,6,'Delta if >25% change within 6h','University of Iowa Pathology Handbook'),
    ('CRP','C-Reactive Protein','Inflammation',NULL,NULL,NULL,'<10','mg/L','Serum',NULL,NULL,'Immunoturbidimetric',4,
     'Acute-phase reactant used for infection/inflammation monitoring',30,24,'Delta if >30% change vs prior day','WHO Basic Laboratory Tests'),

    -- Endocrine / Diabetes / Thyroid
    ('HBA1C','Hemoglobin A1c','Endocrinology',NULL,NULL,NULL,'4.0-5.6','%','Whole Blood (EDTA)',NULL,NULL,'HPLC (NGSP aligned)',24,
     'Chronic glycemic control marker (≈3 months)',5,720,'Delta if >0.5% absolute change within 3 months','WHO Basic Laboratory Tests'),
    ('TSH','Thyroid Stimulating Hormone','Endocrinology',NULL,NULL,NULL,'0.4-4.5','µIU/mL','Serum',NULL,NULL,'3rd generation immunoassay',24,
     'Primary thyroid axis screening test',20,168,'Delta if >20% change vs prior week','University of Iowa Pathology Handbook'),
    ('FT4','Free T4','Endocrinology',NULL,NULL,NULL,'0.8-1.8','ng/dL','Serum',NULL,NULL,'Equilibrium dialysis immunoassay',24,
     'Biologically active thyroxine fraction',20,168,'Delta if >20% change vs prior week','University of Iowa Pathology Handbook'),
    ('FT3','Free T3','Endocrinology',NULL,NULL,NULL,'2.3-4.2','pg/mL','Serum',NULL,NULL,'Chemiluminescent immunoassay',24,
     'Triiodothyronine for hyperthyroid evaluation',20,168,'Delta if >20% change vs prior week','University of Iowa Pathology Handbook'),

    -- Urinalysis
    ('UASG','Urine Specific Gravity','Urinalysis','Urinalysis',NULL,NULL,'1.005-1.030','Ratio','Urine',NULL,NULL,'Refractometer',2,
     'Concentration ability of kidney',5,24,'Delta if shift >0.005 within 24h for DI monitoring','WHO Basic Laboratory Tests'),
    ('UAPH','Urine pH','Urinalysis','Urinalysis',NULL,NULL,'5.0-8.0','pH','Urine',NULL,NULL,'pH indicator dipstick',2,
     'Acid-base status, infection, renal stone risk',20,24,'Delta if >20% change (~0.8 pH units)','WHO Basic Laboratory Tests'),
    ('UAPROT','Urine Protein','Urinalysis','Urinalysis',NULL,NULL,'Negative','Qualitative','Urine',NULL,NULL,'Dipstick colorimetric',2,
     'Screens for nephropathy',NULL,NULL,NULL,'WHO Basic Laboratory Tests'),
    ('UAGLU','Urine Glucose','Urinalysis','Urinalysis',NULL,NULL,'Negative','Qualitative','Urine',NULL,NULL,'Glucose oxidase dipstick',2,
     'Detects glycosuria in diabetes',NULL,NULL,NULL,'WHO Basic Laboratory Tests'),
    ('UAKET','Urine Ketones','Urinalysis','Urinalysis',NULL,NULL,'Negative','Qualitative','Urine',NULL,NULL,'Nitroprusside dipstick',2,
     'Identifies ketoacidosis or starvation ketosis',NULL,NULL,NULL,'WHO Basic Laboratory Tests'),
    ('UABLD','Urine Blood','Urinalysis','Urinalysis',NULL,NULL,'Negative','Qualitative','Urine',NULL,NULL,'Peroxidase activity dipstick',2,
     'Screens for hematuria/hemoglobinuria',NULL,NULL,NULL,'WHO Basic Laboratory Tests'),

    -- Serology / Infectious disease
    ('HBSAG','Hepatitis B Surface Antigen','Serology',NULL,NULL,NULL,'Negative','Qualitative','Serum',NULL,NULL,'CLIA immunoassay',24,
     'Detects active HBV infection',NULL,NULL,NULL,'WHO Basic Laboratory Tests'),
    ('HCVAB','Hepatitis C Antibody','Serology',NULL,NULL,'Negative','Qualitative','Serum',NULL,NULL,'CLIA immunoassay',24,
     'Screens for HCV exposure',NULL,NULL,NULL,'WHO Basic Laboratory Tests'),
    ('HIV12','HIV 1/2 Ag/Ab Combo','Serology',NULL,NULL,NULL,'Negative','Qualitative','Serum/Plasma',NULL,NULL,'4th generation immunoassay',24,
     'Serologic screening for HIV infection',NULL,NULL,NULL,'WHO Basic Laboratory Tests'),

    -- Arterial Blood Gas
    ('ABGPH','Arterial pH','Blood Gas','Arterial Blood Gas Panel',NULL,NULL,'7.35-7.45','pH','Arterial Whole Blood (Heparin)','<7.20','>7.60','Potentiometric electrode',0.5,
     'Acid-base snapshot for critical patients',1,6,'Delta if pH change >0.1 within 6h','University of Iowa Pathology Handbook'),
    ('PCO2','Arterial pCO2','Blood Gas','Arterial Blood Gas Panel',NULL,NULL,'35-45','mmHg','Arterial Whole Blood (Heparin)','<25','>70','Severinghaus electrode',0.5,
     'Ventilation marker in ABG',20,6,'Delta if >20% change within 6h','University of Iowa Pathology Handbook'),
    ('PO2','Arterial pO2','Blood Gas','Arterial Blood Gas Panel',NULL,NULL,'80-100','mmHg','Arterial Whole Blood (Heparin)','<50','>200','Clark electrode',0.5,
     'Oxygenation status for respiratory failure management',25,6,'Delta if >25% drop within 6h','University of Iowa Pathology Handbook'),
    ('HCO3','Bicarbonate (Calculated)','Blood Gas','Arterial Blood Gas Panel',NULL,NULL,'22-26','mmol/L','Arterial Whole Blood (Heparin)','<10','>40','Derived from pH/pCO2',0.5,
     'Metabolic component of acid-base balance',20,6,'Delta if >20% change within 6h','University of Iowa Pathology Handbook')
  ) AS t(test_code, test_name, category, panel_name, reference_range_male, reference_range_female, reference_range_general, unit_of_measure, sample_type, panic_low, panic_high, method, turnaround_time_hours, description, delta_check_percent, delta_check_hours, delta_check_notes, guideline_source)
)
INSERT INTO public.lab_test_master (
  test_code,
  test_name,
  category,
  panel_name,
  reference_range_male,
  reference_range_female,
  reference_range_general,
  unit_of_measure,
  sample_type,
  critical_low,
  critical_high,
  panic_low,
  panic_high,
  method,
  turnaround_time_hours,
  description,
  delta_check_percent,
  delta_check_hours,
  delta_check_notes,
  guideline_source,
  is_active
)
SELECT
  test_code,
  test_name,
  category,
  panel_name,
  reference_range_male,
  reference_range_female,
  reference_range_general,
  unit_of_measure,
  sample_type,
  panic_low,
  panic_high,
  panic_low,
  panic_high,
  method,
  turnaround_time_hours,
  description,
  delta_check_percent,
  delta_check_hours,
  delta_check_notes,
  guideline_source,
  true
FROM master_data
ON CONFLICT (test_code) DO UPDATE
SET
  test_name = EXCLUDED.test_name,
  category = EXCLUDED.category,
  panel_name = EXCLUDED.panel_name,
  reference_range_male = EXCLUDED.reference_range_male,
  reference_range_female = EXCLUDED.reference_range_female,
  reference_range_general = EXCLUDED.reference_range_general,
  unit_of_measure = EXCLUDED.unit_of_measure,
  sample_type = EXCLUDED.sample_type,
  panic_low = EXCLUDED.panic_low,
  panic_high = EXCLUDED.panic_high,
  method = EXCLUDED.method,
  turnaround_time_hours = EXCLUDED.turnaround_time_hours,
  description = EXCLUDED.description,
  delta_check_percent = EXCLUDED.delta_check_percent,
  delta_check_hours = EXCLUDED.delta_check_hours,
  delta_check_notes = EXCLUDED.delta_check_notes,
  guideline_source = EXCLUDED.guideline_source,
  updated_at = now();
